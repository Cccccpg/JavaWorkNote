# 针对项目难点

<img src="pictures\image-20230801144147879.png" alt="image-20230801144147879" />

![image-20230801144220366](pictures\image-20230801144220366.png)

## 1、说一说什么是微服务，为什么要用微服务呢？

### 微服务定义

微服务是一种开发软件的架构和组织方法，其中软件由通过明确定义的API进行通信的小型独立服务组成。微服务架构使得应用程序**更易于扩展和更快地开发**。使用微服务架构可以将应用程序构建为独立的组件，并将每个应用程序进行作为一项服务运行。在对服务进行更新的时候不向整体式架构那样复杂，只需要针对各项服务进行更新、部署和扩展即可。

简单来讲，**微服务将一个复杂的应用拆分成多个独立自治的服务**，服务和服务之间通过**松耦合的形式**交互。

### 为什么要用微服务？（微服务优点有哪些？）

微服务的优点：

1. 不同的服务可以使用不同的技术；
2. 隔离性。一个服务不可用不会导致其他服务不可用；
3. 可扩展性。某个服务出现性能瓶颈，只需对此服务进行升级即可；
4. 简化部署。服务的部署是独立的，哪个服务出现问题，只需对此服务进行修改重新部署；

## 2、项目中的微服务是怎么划分的呢？

我们这个项目的微服务是**根据业务功能**进行的划分的，比如用户服务、医院服务、订单服务这几个微服务。

考虑到系统的复用性，由于在用户服务模块中的登录功能和订单服务中发送短信功能都用到了阿里云的短信服务，所以也将短信服务独立出来成为一个微服务。

## 3、那项目中微服务之间如何进行通信的呢？

微服务通信方式主要有两种：**同步调用**和**异步调用**。

- 对于同步调用，这个项目中我们使用了SpringCloud中的Feign组件来实现。在不同的微服务之间调用时，我们将调用功能封装到了一个新的client微服务模块中。
  1. 在该模块的pom文件中引入openfeign依赖，并新建一个接口用于调用的封装；
  2. 然后使用`@FeignClient`注解来表明需要调用的微服务名称，这个名称就是在Nacos中注册的名称；
  3. 然后在接口内部，将要调用的方法直接复制过来，并在Mapping注解中补充完整方法的路径。在参数的`@PathVariable`注解中也要指定参数的名称。
  4. 最后在使用到的微服务模块的微服务中进行调用，在相应的pom文件中引入对应的client依赖，在需要调用的地方使用`@Autowired`注解注入，至此，使用Feign组件完成了远程调用。
- 对于异步调用，这个项目中我们用到的是RabbitMQ来实现的。比如在用户模块中的手机验证码登录功能中，需要发送短信，所以需要远程调用短信服务模块中的发送短信功能，可以将短信交给短信队列，用户模块作为生产者，而短信模块作为消费者帮忙发送短信。

## 4、RPC了解吗？简单说一说RPC调用的过程

**RPC** 即**远程过程调用**（Remote Procedure Call Protocol，简称RPC），**像调用本地服务(方法)一样调用服务器的服务(方法)**。RPC是分布式架构的核心，也可以分为：**同步调用**和**异步调用**。

### RPC远程调用的过程

PRC架构中有四个组件：

1. 客户端(Client)：就是服务的调用方；
2. 客户端存根(Client Stub)：存放服务端地址信息，将客户端的请求参数打包成网络消息，再通过网络发送给服务方；
3. 服务端存根(Server Stub)：接受客户端发送过来的消息并解包，再调用本地服务；
4. 服务端(Server)：真正的服务提供者，也就是被调用方。

<img src="C:\Users\Acer\AppData\Roaming\Typora\typora-user-images\image-20230801151535538.png" alt="image-20230801151535538" style="zoom:150%;" />

1. 客户端**以本地调用方式调用服务**；
2. 客户端存根接收到调用后负责**将方法、参数等组装成能够进行网络传输的消息体**，就是**序列化**的过程；
3. 客户端存根**找到服务地址**，并将消息通过网络发送到服务端；
4. 服务端存根**收到消息后进行解码**，就是**反序列化**的过程；
5. 服务端存根根据解码结果**调用本地服务**；
6. 服务端**执行处理逻辑**；
7. 服务端**将结果返回**给服务端存根；
8. 服务端存根**将返回结果打包成消息体**，也就是**序列化**；
9. 服务端存根**将打包后的消息通过网络发送至客户端存根**；
10. 客户端存根**接收到消息，并进行解码**，就是**反序列化**；
11. 客户端得到最终结果。

而RPC框架的目的就是把中间的这些步骤（2-10）封装起来，也就是把调用、编码、解码的过程封装起来，**让用户像调用本地服务一样的调用远程服务**。

## 5、什么是跨域问题？用Nginx怎么解决？为什么后面又改用Gateway了？

### 跨域问题

跨域问题是浏览器的**同源策略限制**，同源策略会组织一个域的js脚本和另一个域的内容进行交互。所谓的同源就是指两个页面有相同的协议、主机号、端口号。

当一个请求地址中的**访问协议**、**域名(IP地址)**、**端口号**有任何一个与当前页面不一样就会产生跨域问题。（注：如果访问协议、域名和端口号都相同，但是请求路径不同，不属于跨域，比如[www.jd.com/item](http://www.jd.com/item)和[www.jd.com/goods。](http://www.jd.com/goods。)）

由于微服务中不同的服务端口号不同，用户在各个页面进行跳转时，所以一定会存在跨域问题。

### 使用Nginx解决跨域问题

![image-20230801153946788](pictures\image-20230801153946788.png)

由于后台有很多服务模块，每个模块都有对应的访问路径与端口，为了提供统一的api接口，可以使用Nginx作为反向代理服务器。正向与反向，是相对于用户来说的。

---

- 正向是用户主动配置代理服务器，比如科学上网。

- 反向是用户想要访问某些网站，需要先将请求发送到网站的反向代理服务器，由反向代理服务器再转发到真正的服务器。网站对外暴露的是代理服务器的地址，隐藏了真实服务器的地址。

---

Nginx把客户端的http请求转发到另一个或者一些服务器上。通过把本地一个url前缀映射到要跨域访问的web服务器上，就可以实现跨域访问。

对于浏览器来说，请求访问的就是同源服务器上的一个url。而Nginx通过检测url前缀，把http请求转发到后面真实的物理服务器。并通过`rewrite`命令把前缀再去掉。这样真实的服务器就可以正确处理请求，并且并不知道这个请求是来自代理服务器的。

如何使用Nginx？

1. 下载安装Nginx（Windows版）；

2. 编辑Nginx的配置文件`nginx.conf`，编辑统一个访问端口，然后再编辑每个微服务的访问规则；

   ```properties
   server {
           listen       9001;			//访问的端口
           server_name  localhost;		//主机名
   	//以下是两条访问规则，路径包含hosp、cmn，就分别转发到相应的端口。
   	//其中~表示正则匹配。
   	location ~ /hosp/ {           
   	    proxy_pass http://localhost:8201;
   	}
   	location ~ /cmn/ {           
   	    proxy_pass http://localhost:8202;
   	}
   }
   ```

3. 前端只需要设置请求路径，让请求先访问定义的统一访问端口，再由Nginx网关根据进行相应规则进行转发；

4. 最后在对应的Controller上添加`@CrossOrigin`注解，即可解决跨域问题。

### 为什么后面改用Gateway解决了呢？

随着业务的增多，微服务模块的增多，再继续使用Nginx配置就比较繁琐了。因为每新增一个微服务，就需要去`nginx.conf`文件中添加访问规则，并且最麻烦的是需要在每个模块里所有的Controller上添加跨域注解。

通过配置的网关信息，既可以解决跨域问题，又可以实现路由转发。使用了gateway就需要把之前接口上的`@CrossOrigin`注解去掉，否则会出错。

如何使用Gateway？

1. 搭建`service-gateway `模块，在pom.xml中添加gateway依赖，注意 gateway 微服务也需要在 Nacos 中进行注册(添加服务注册依赖)；
2. 修改 application.properties 文件，添加相关配置。比如设置服务端口、服务名、 nacos 服务地址、设置路由等；
3. 添加启动类。

## 6、说说什么是Nacos？为什么要用Nacos？什么是注册中心？什么是配置中心？

Nacos 是阿里巴巴开源的一个构建云原生应用的动态服务发现、配置管理的平台，可以作为注册中心和配置中心。

由于订单模块中预约挂号功能需要获取医院信息和就诊人信息，而这两个信息分别属于用户模块和医院模块，所以必须要进行远程调用。用到的技术就是使用注册中心和远程调用，而Nacos是一个很好的选择。

每个微服务在Nacos配置中心进行服务注册，然后就可以利用服务名、IP地址及端口号互相进行远程调用。

### 什么是注册中心？

比如服务A需要调用服务B，但此时服务A并不知道服务B在哪几台服务器上，而且也不知道服务B是正常状态还是下线状态。为了解决这个问题，所以注册中心就出现了。

![image-20230801161404441](pictures\image-20230801161404441.png)

注册中心原理：

- 服务注册的策略的是每5秒向nacos server发送一次心跳，心跳带上了服务名，服务ip，服务端口等信息。
- Nacos服务端也会向客户端主动发起健康检查，支持tcp/http检查。
  - 如果15秒内无心跳且健康检查失败则认为这个服务不健康；
  - 如果30秒内健康检查失败则剔除服务。

简单来说：已经在Nacos注册过的服务可以实时感知到其他服务的状态，如果某些服务下线，其他服务也能实时感知，从而避免调用不可用的服务。

### 什么是配置中心？

每个服务都有大量的配置，并且每个微服务都可能部署在多台机器上。不可避免的就需要经常变更配置，可以让每个微服务通过配置中心获取自己的配置。

配置中心主要用来集中管理微服务的配置信息。

![image-20230801164252775](pictures\image-20230801164252775.png)

如何使用Nacos？

1. 下载和安装；
2. 在pom文件中引入Nacos依赖；
3. 在配置文件中添加Nacos服务的地址；
4. 在启动类上添加`@EnableDiscoveryClient`注解，开启服务注册，服务启动后就会在Nacos注册中心进行注册；

## 7、Feign组件是如何进行远程调用的？

Feign远程调用的核心就是**通过一系列的封装和处理，将以JAVA注解的方式定义的远程调用API接口，最终转换成HTTP的请求形式，然后将HTTP的请求的响应结果，解码成JAVA Bean，放回给调用者。**

Feign远程调用的基本流程，大致如下图所示：

![image-20230801165638166](pictures\image-20230801165638166.png)

## 8、说说RPC和HTTP的区别

**相同点：**都可以进行远程调用；

**不同点**：RPC要求客户端（服务调用方）和服务端（服务提供方）都使用相同的技术，而HTTP无需关注语言的实现，只需要遵守rest规范即可。

## 9、什么是REST规范？

REST是一种软件架构风格，REST通过HTTP协议定义的通用动词方法（GET、POST、PUT、DELETE），以URI对网络资源进行唯一标识，响应端根据请求端不同的需求，通过无状态通信，对其请求的资源进行表述。

  Rest架构的主要原则：

1. 网络上的所有事物都被抽象为资源；
2. 每个资源都有一个唯一的资源标识符；
3. 同一个资源具有多种表现形式(xml,json等)；
4. 对资源的各种操作不会改变资源标识符；
5. 所有的操作都是无状态的

RESTful风格体现在

- 使用了Get请求，就是查询；
- 使用Post请求,就是新增的请求；
- 使用Put请求，就是修改的请求；
- 使用Delete请求，就是删除的请求。

这样做就完全没有必要对crud做具体的描述。



